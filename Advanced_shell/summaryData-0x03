#!/bin/bash

# Configuration
INPUT_DIR="pokemon_data"
OUTPUT_FILE="pokemon_report.csv"
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

# Initialize CSV file with header
echo "Name,Height (m),Weight (kg)" > "$OUTPUT_FILE"

# Process each JSON file
for file in "$INPUT_DIR"/*.json; do
    # Extract and format data using jq
    jq -r '
        .name as $name | 
        (.height/10) as $height | 
        (.weight/10) as $weight |
        "\($name | sub("^."; .[:1] | ascii_upcase)),\($height),\($weight)"
    ' "$file" >> "$OUTPUT_FILE"
done

# Use sed to clean up any trailing .0 on whole numbers
sed -i 's/\.0,/,/g; s/\.0$//' "$OUTPUT_FILE"

# Calculate and display averages using awk
awk -F, '
NR == 1 {
    print $0  # Print header
    next
}
{
    print $0  # Print data rows
    height_sum += $2
    weight_sum += $3
    count++
}
END {
    printf "\nAverage Height: %.2f m\n", height_sum/count
    printf "Average Weight: %.2f kg\n", weight_sum/count
    printf "\nReport generated on: '"$TIMESTAMP"'\n"
}
' "$OUTPUT_FILE" > temp_report && mv temp_report "$OUTPUT_FILE"

echo "CSV Report generated at: $OUTPUT_FILE"